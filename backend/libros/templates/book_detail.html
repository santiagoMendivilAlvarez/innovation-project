{% extends 'utils/base.html' %}

{% block title %}{{ book.title }} - BookieWookie{% endblock %}

{% block content %}
<div class="detail-wrapper">
    {% if error %}
        <div class="error-message">
            <strong>‚ö†Ô∏è Error:</strong> {{ error }}
        </div>
    {% endif %}

    {% if book %}
        <nav class="breadcrumb">
            <a href="/">Inicio</a> / 
            <a href="javascript:history.back()">B√∫squeda</a> / 
            <span>{{ book.title|default:"Libro" }}</span>
        </nav>

        <div class="book-main-card">
            <div class="inicio-ficcion">
                <button class="agregar-btn" onclick="agregarABiblioteca()">
                    <span>‚≠ê</span>
                    <span>Agregar a Biblioteca</span>
                </button>
            </div>

            <!-- Book Header -->
            <div class="book-header">
                <!-- Cover -->
                <div class="book-cover-section">
                    {% if book.thumbnail %}
                        <img src="{{ book.thumbnail }}" alt="{{ book.title }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="book-cover-placeholder" style="display: none;">
                            üìö
                        </div>
                    {% else %}
                        <div class="book-cover-placeholder">
                            üìö
                        </div>
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="book-info-section">
                    <h1>{{ book.title|default:"Sin t√≠tulo" }}</h1>
                    
                    {% if book.authors %}
                        {% if book.authors.0 %}
                            <p class="book-author">Por {{ book.authors.0 }}</p>
                        {% elif book.authors %}
                            <p class="book-author">Por {{ book.authors|join:", " }}</p>
                        {% endif %}
                    {% else %}
                        <p class="book-author">Autor desconocido</p>
                    {% endif %}

                    <div class="book-description">
                        {% if book.description %}
                            {{ book.description|safe }}
                        {% else %}
                            <p style="color: #999; font-style: italic;">No hay descripci√≥n disponible para este libro.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Detalles del libro -->
            <div class="detalles-section">
                <h2>Detalles del libro</h2>
                <div class="detalles-grid">
                    <div class="detalle-item">
                        <div class="detalle-label">G√©nero</div>
                        <div class="detalle-value">
                            {% if book.categories %}
                                {% if book.categories.0 %}
                                    {{ book.categories.0 }}
                                {% else %}
                                    {{ book.categories|join:", " }}
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">A√±o de publicaci√≥n</div>
                        <div class="detalle-value">
                            {% if book.published_date %}
                                {{ book.published_date|slice:":4" }}
                            {% elif book.publishedDate %}
                                {{ book.publishedDate|slice:":4" }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">No. p√°ginas</div>
                        <div class="detalle-value">
                            {% if book.page_count %}
                                {{ book.page_count }}
                            {% elif book.pageCount %}
                                {{ book.pageCount }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="disponibilidad-section">
                <h2>Disponibilidad</h2>

                {% if availability_options %}
                    <div class="availability-filters">
                        <button class="filter-btn active">Precio</button>
                        <button class="filter-btn">Stock</button>
                        <button class="filter-btn">Idioma</button>
                        <button class="filter-btn">Plataforma</button>
                    </div>

                    <div class="availability-options">
                        {% for option in availability_options %}
                        <div class="availability-card">
                            <div class="availability-card-content">
                                <div class="platform-logo-section">
                                    {% if option.platform_logo == 'mercadolibre' %}
                                        <div class="platform-logo mercadolibre-logo">
                                            <svg viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="25" cy="25" r="15" fill="#FFE600"/>
                                                <path d="M 20 20 L 25 30 L 30 20" stroke="#000" stroke-width="2" fill="none"/>
                                            </svg>
                                        </div>
                                    {% elif option.platform_logo == 'amazon' %}
                                        <div class="platform-logo amazon-logo">
                                            <svg viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg">
                                                <text x="10" y="30" font-family="Arial" font-size="24" font-weight="bold" fill="#FF9900">a</text>
                                                <path d="M 15 32 Q 40 28 50 32" stroke="#FF9900" stroke-width="2" fill="none"/>
                                            </svg>
                                        </div>
                                    {% elif option.platform_logo == 'google' %}
                                        <div class="platform-logo google-logo">üìö</div>
                                    {% endif %}
                                </div>

                                <div class="availability-info">
                                    <div class="availability-header">
                                        <h3 class="platform-name">{{ option.platform }}</h3>
                                        {% if option.price %}
                                            <div class="price-tag">{{ option.price }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="availability-details">
                                        <div class="detail-item">
                                            ‚Ä¢ Idioma: <strong>{{ option.language }}</strong>
                                        </div>
                                        <div class="detail-item">
                                            ‚Ä¢ Formato: <strong>{{ option.format }}</strong>
                                        </div>
                                        <div class="detail-item">
                                            ‚Ä¢ Stock: <strong>{{ option.stock }}</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="availability-actions">
                                    {% if option.show_favorite %}
                                        <button class="favorite-btn" onclick="agregarABiblioteca()" title="Agregar a favoritos">
                                            <span>‚≠ê</span>
                                        </button>
                                    {% elif option.rating %}
                                        <button class="rating-btn" title="Calificaci√≥n">
                                            <span>{{ option.rating }}</span>
                                        </button>
                                    {% endif %}
                                    {% if option.link %}
                                        <a href="{{ option.link }}" target="_blank" class="availability-link-btn">
                                            {{ option.link_text }}
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="more-options-link">
                        <a href="javascript:void(0)">Ver m√°s opciones</a>
                    </div>
                {% else %}
                    <div class="placeholder-box">
                        <p>üì¶ Informaci√≥n de disponibilidad y precios</p>
                        <p>No hay opciones de compra disponibles en este momento</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="book-main-card">
            <div class="libros-relacionados-section">
                <h2>Libros relacionados</h2>

                {% if related_books %}
                    <div class="libros-grid-relacionados">
                        {% for related_book in related_books %}
                        <a href="{% url 'book_detail' related_book.id %}?source={{ related_book.source }}" class="libro-card-relacionado">
                            <div class="libro-portada-relacionado">
                                {% if related_book.thumbnail %}
                                    <img src="{{ related_book.thumbnail }}" alt="{{ related_book.title }}"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="libro-portada-placeholder" style="display: none;">
                                        üìö
                                    </div>
                                {% else %}
                                    <div class="libro-portada-placeholder">
                                        üìö
                                    </div>
                                {% endif %}
                            </div>
                            <div class="libro-info-relacionado">
                                <h4>{{ related_book.title|truncatewords:8 }}</h4>
                                {% if related_book.authors %}
                                    <p class="libro-autor">{{ related_book.authors.0 }}</p>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="placeholder-box" style="padding: 70px 20px;">
                        <p>üìö Recomendaciones personalizadas</p>
                        <p>Cargando recomendaciones...</p>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="error-message">
            <strong>‚ö†Ô∏è Libro no encontrado</strong>
            <p>No se pudo cargar la informaci√≥n del libro solicitado.</p>
        </div>
    {% endif %}
</div>

<script>
function agregarABiblioteca() {
    alert('Funcionalidad de biblioteca en desarrollo üìö');
}
</script>
{% endblock %}